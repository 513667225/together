<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>修改商品信息</title>
</head>
<link rel="stylesheet" href="/js/layui/css/layui.css">
<script src="/js/layui/layui.all.js"></script>
<body>

<form class="layui-form layui-form-pane" action="/goods/addGoods" id="goodsAddSubmit" method="post">

    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
        <legend>商品基本信息</legend>
    </fieldset>

    <div class="layui-form-item">
        <label class="layui-form-label">商品名称</label>
        <div class="layui-input-block">
            <input name="goodsName" id="goodsName" type="text" class="layui-input"
                   placeholder="请输入商品名称,不超过20个字" lay-verify="required" autocomplete="off">
        </div>
    </div>

    <div class="layui-form-item" pane="">
        <label class="layui-form-label">是否上架</label>
        <div class="layui-input-block">
            <input type="checkbox" checked name="isOnSale" lay-skin="switch" lay-text="是|否">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">所属分类</label>
        <div class="layui-input-inlin">
            <div class="layui-input-inline">
                <select name="category1" id="category1" lay-filter="category1">
                </select>
            </div>
            <div class="layui-input-inline">
                <select name="category2" id="category2" lay-filter="category2">
                    <option value="">请选择子类目</option>
                </select>
            </div>
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">商品单位</label>
        <div class="layui-input-inline">
            <input name="goodsUnit" id="goodsUnit" type="text" placeholder="请输入商品单位,例如件、盒" class="layui-input"
                   lay-verify="required" autocomplete="off">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">商品单价</label>
        <div class="layui-input-inline">
            <input name="goodsPrice" id="goodsPrice" type="text" placeholder="￥" class="layui-input"
                   lay-verify="required|number" autocomplete="off">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">商品库存</label>
        <div class="layui-input-inline">
            <input name="goodsInventory" id="goodsInventory" type="text" placeholder="请输入商品库存" class="layui-input"
                   lay-verify="required|number" autocomplete="off" oninput="value=value.replace(/[^\d]/g,'')">
        </div>
    </div>

    <blockquote class="layui-elem-quote layui-text">
        Tips:商品首页图,建议图片比列为4:3
    </blockquote>
    <div class="layui-form-item">
        <label class="layui-form-label">商品首页图</label>
        <div class="layui-upload-drag" id="picUrlUpload">
            <i class="layui-icon"></i>
            <p>点击上传或者拖拽图片上传</p>
        </div>
    </div>
    <blockquote class="layui-elem-quote layui-quote-nm" style="margin-top: 10px;">
        预览图：
        <div class="layui-upload-list" id="picUrlPreview"></div>
    </blockquote>

    <!-- 商品宣传图片上传 -->
    <blockquote class="layui-elem-quote layui-text">
        Tips:商品宣传图列表,建议图片比列为16:9,商品宣传图数量不可超过5张
    </blockquote>
    <div class="layui-form-item">
        <label class="layui-form-label">商品宣传图</label>
        <div class="layui-upload-drag" id="goodsGalleryListUpload">
            <i class="layui-icon"></i>
            <p>点击上传或者拖拽图片上传</p>
        </div>
    </div>
    <blockquote class="layui-elem-quote layui-quote-nm" style="margin-top: 10px;">
        预览图：
        <div class="layui-upload-list" id="goodsGalleryPreview"></div>
    </blockquote>

    <blockquote class="layui-elem-quote layui-text">
        Tips:为了用户观感,设计商品详情页内容时内容和图片大小宽建议为200PX,且内容尽量以图片的形式展示
    </blockquote>
    <div class="layui-form-item">
        <label class="layui-form-label">商品详情页</label>
        <div class="layui-input-block">
            <textarea name="goodsDetail" id="goodsDetail"></textarea>
        </div>
    </div>

    <!-- 商品规格信息 -->
    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
        <legend>商品规格信息</legend>
    </fieldset>
    <blockquote class="layui-elem-quote layui-text">
        Tips:商品规格图片,建议图片比列为16:9
    </blockquote>
    <div class="layui-form-item">
        <label class="layui-form-label">规格名字</label>
        <div class="layui-input-block">
            <input name="specificationName" id="specificationName" type="text" placeholder="请输入商品规格,例如:红色衣服,XL" class="layui-input"
                   lay-verify="required" autocomplete="off">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">商品规格图</label>
        <div class="layui-upload-drag" id="specificationPicUpload">
            <i class="layui-icon"></i>
            <p>点击上传或者拖拽图片上传</p>
        </div>
    </div>
    <blockquote class="layui-elem-quote layui-quote-nm" style="margin-top: 10px;">
        预览图：
        <div class="layui-upload-list" id="specificationPicPreview"></div>
    </blockquote>

    <!-- 商品参数设置 -->
    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
        <legend>商品参数设置</legend>
    </fieldset>
    <!-- 商品参数 -->
    <div class="layui-form-item">
        <label class="layui-form-label">商品参数</label>
        <div class="layui-input-inline">
            <button type="button" id="addAttribute" class="layui-btn layui-btn-primary"><i class="layui-icon">&#xe608;</i> 添加参数</button>
        </div>
    </div>
    <!-- 商品参数表格 -->
    <div style="padding: 20px; background-color: #F2F2F2;">
        <div class="layui-row layui-col-space15">
            <div class="layui-col-md12">
                <div class="layui-card">
                    <div class="layui-card-header">商品参数信息</div>
                    <div class="layui-card-body" >
                        <table class="layui-table" id="attributeTable">
<!--                            <tbody id="attributeTableContent">-->

<!--                            </tbody>-->
                            <tr>
                                <td>参数名</td>
                                <td>值</td>
                                <td>操作</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="layui-form-item" style="display: none">
        <div class="layui-input-block">
            <input id="picUrl" name="picUrl" type="text" class="layui-input" autocomplete="off"> <input>
            <input id="specificationPic" name="specificationPic" type="text" class="layui-input" autocomplete="off"> <input>
            <input id="goodsGallery" name="goodsGallery" type="text" class="layui-input" autocomplete="off"> <input>
            <input id="attributeEntity" name="attributeEntity" type="text" class="layui-input" autocomplete="off"> <input>
        </div>
    </div>

    <!-- 提交按钮 -->
    <div class="layui-form-item" style="margin-top:40px">
        <div class="layui-input-block" style="text-align: center;">
            <button type="button" class="layui-btn" lay-filter="doSubmit" id="submitBtn">
                <span class="layui-icon layui-icon-add-1"></span>
                提交
            </button>
            <button type="reset" class="layui-btn layui-btn-warm">
                <span class="layui-icon layui-icon-refresh-1"></span>
                重置
            </button>
        </div>
    </div>

</form>

<!-- 弹窗设置参数content -->
<div class="layui-row" id="attributeMessage" style="display:none;">
    <div class="layui-col-md12">
        <form class="layui-form layui-from-pane" action="" style="margin-top:20px">
            <div class="layui-form-item">
                <label class="layui-form-label">参数名</label>
                <div class="layui-input-inline">
                    <input type="text" name="attributeName" id="attributeName" lay-verify="required" autocomplete="off" placeholder="请输入参数名" class="layui-input">
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">参数值</label>
                <div class="layui-input-inline">
                    <input type="text" name="attributeValue" id="attributeValue" lay-verify="required" autocomplete="off" placeholder="请输入参数值" class="layui-input">
                </div>
            </div>

            <div class="layui-form-item" style="margin-top:40px">
                <div class="layui-input-block">
                    <button class="layui-btn  layui-btn-submit " lay-submit="" lay-filter="attributeSubmit">添加</button>
                    <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                </div>
            </div>
        </form>
    </div>
</div>
</body>
<script>
    var goodsGrallyList={};
    goodsGrallyList.title="xxx";
    goodsGrallyList.id="xxx";
    goodsGrallyList.start=0;
    var dataArray = new Array();
    var specificationPicFilePath;
    var picUrlFilePathFilePath;


    layui.extend({tinymce: '/js/tinymce/tinymce'}).use(['jquery', 'form', 'util', 'layer', 'tinymce','upload'], function () {
        var $ = layui.jquery;
        var form = layui.form,
            layer = layui.layer,
            layedit = layui.layedit,
            upload = layui.upload,
            laydate = layui.laydate;
        var util = layui.util;
        var tinymce = layui.tinymce;

        //表单渲染
        form.render();

        //初始化tinymce
        var goods_detail = tinymce.render({
            elem: "#goodsDetail",
            height: 300,
            width: '99%',
            images_upload_url: '/goods/uploadGoods',
        }, (opt) => {
            //加载完成后回调
        });

        //初始化
        init();

        //商品参数设置相关
        var attributeIndex;
        //添加商品参数
        $("#addAttribute").click(function(){
            attributeIndex = layer.open({
                type:1,
                title:'添加商品参数信息',
                area : ['370px', '270px'],
                shadeClose:true,
                content: $("#attributeMessage")
            });
        });
        //提交商品参数信息
        form.on('submit(attributeSubmit)', function(data) {
            layer.close(attributeIndex);
            $("#attributeName").val("");
            $("#attributeValue").val("");
            var attributeTrHtml = "<tr>"
            attributeTrHtml += "<td>"+data.field.attributeName+"</td>"
            attributeTrHtml += "<td>"+data.field.attributeValue+"</td>"
            attributeTrHtml += "<td align:'center'><button class='layui-btn layui-btn-primary layui-btn-sm attributeDelete'>删除</button></td>"
            attributeTrHtml += "</tr>"
            $("#attributeTable").append(attributeTrHtml);
            return false;
        })
        //删除商品参数
        $("#attributeTable").on('click', '.attributeDelete', function () {
            $(this).closest('tr').remove();
        });
        //商品参数表格转json
        function table2Json(id) {
            var titles = $("#" + id).find("tr:first td");
            var json = "[" + $("#" + id).find("tr:not(:first)").map(function(i, e) {
                return "{" + $(e).children("td").map(function(j, el) {
                    return $(titles[j]).html() + ':"' + $(el).html() +'"';
                }).get().join(",") + "}";
            }).get().join(",") + "]";
            var reg1 = new RegExp('参数名','g');
            json = json.replace(reg1,'"attributeName"');
            var reg2 = new RegExp('值','g');
            json = json.replace(reg2,'"attributeValue"');
            var reg3 = new RegExp(',操作:"<button class="layui-btn layui-btn-primary layui-btn-sm attributeDelete">删除</button>"','g');
            json = json.replace(reg3,'');
            return json;
        }


        //商品宣传图片上传 限制5张
        upload.render({
            elem: '#goodsGalleryListUpload',
            url: '/goods/uploadGoods',
            multiple: true,
            acceptMime: 'image/*',
            auto: false,
            size: 5120,
            bindAction: '#submitBtn',//submitBtn
            choose:function(obj){
                // obj.preview(function(index, file, result){
                //     $('#goodsGalleryPreview').append('<img id="goodsGrally'+index+'" style="width: 256px;height: 144px;margin-left: 10px" src="'+ result +'" alt="'+ file.name +'" class="layui-upload-img">')
                // });
                var files = obj.pushFile();
                var len = getJsonLength(files);
                obj.preview(function (index, file, result) {
                    if(parseInt(len)>5){
                        layer.msg("上传商品宣传图片数量不能超过五张", {icon: 5});
                        delete files[index];
                        len = getJsonLength(files);
                    }else{
                        $('#goodsGalleryPreview').append('<img id="goodsGrallyRemove_'+index+'" style="width: 256px;' +
                            'height: 144px;margin-left: 10px" src="'+ result +'" alt="'+ file.name +'" class="layui-upload-img">')
                        $('#goodsGrallyRemove_' + index).bind('dblclick', function () {
                            delete files[index];
                            len = getJsonLength(files);
                            $(this).remove();
                        });
                    }
                })
            },
            done: function(res){
                var jsonTemp={};
                jsonTemp.alt=res.fileName;
                jsonTemp.pid=1;
                jsonTemp.thumb="";
                jsonTemp.src=res.filePath;
                dataArray.push(jsonTemp);
            },
            allDone: function (res) {
                goodsGrallyList.data=dataArray;
                specificationPicUpload.upload();
            }
        });
        //图片json长度
        function getJsonLength(jsonData){
            var jsonLength = 0;
            for(var item in jsonData){
                jsonLength++;
            }
            return jsonLength;
        }

        //商品规格图片上传
        var specificationPicUpload=upload.render({
            elem: '#specificationPicUpload',
            url: '/goods/uploadGoods',
            acceptMime: 'image/*',
            auto: false,
            size: 5120,
           // bindAction: '#submitBtn',
            choose:function(obj){
                var files = obj.pushFile();
                var len = getJsonLength(files);
                obj.preview(function (index, file, result) {
                    if(parseInt(len)>1){
                        layer.msg("商品规格图为一张", {icon: 5});
                        delete files[index];
                        len = getJsonLength(files);
                    }else{
                        $('#specificationPicPreview').append('<img id="specificationPicRemove_'+index+'" style="width: 256px;' +
                            'height: 144px;margin-left: 10px" src="'+ result +'" alt="'+ file.name +'" class="layui-upload-img">')
                        $('#specificationPicRemove_' + index).bind('dblclick', function () {
                            delete files[index];
                            len = getJsonLength(files);
                            $(this).remove();
                        });
                    }
                })
            },
            done:function(res){
                specificationPicFilePath = res.filePath;
                picUrlUpload.upload();
            }
        });

        //商品首页展示图片上传
        var picUrlUpload=upload.render({
            elem: '#picUrlUpload',
            url: '/goods/uploadGoods',
            acceptMime: 'image/*',
            auto: false,
            size: 5120,
            // bindAction: '#submitBtn',
            choose:function(obj){
                var files = obj.pushFile();
                var len = getJsonLength(files);
                obj.preview(function (index, file, result) {
                    if(parseInt(len)>1){
                        layer.msg("商品首页展示图为一张", {icon: 5});
                        delete files[index];
                        len = getJsonLength(files);
                    }else{
                        $('#picUrlPreview').append('<img id="picUrlRemove_'+index+'" style="width: 256px;' +
                            'height: 144px;margin-left: 10px" src="'+ result +'" alt="'+ file.name +'" class="layui-upload-img">')
                        $('#picUrlRemove_' + index).bind('dblclick', function () {
                            delete files[index];
                            len = getJsonLength(files);
                            $(this).remove();
                        });
                    }
                })
            },
            done:function(res){
                picUrlFilePath = res.filePath;
                $("#picUrl").val(picUrlFilePath);
                $("#specificationPic").val(specificationPicFilePath);
                $("#goodsGallery").val(JSON.stringify(goodsGrallyList));
                $("#attributeEntity").val(table2Json("attributeTable"));
                $("#goodsAddSubmit").submit();
            }
        });

        //加载商品分类下拉框
        function init() {
            $.ajax({
                url: '/category/getCategoryPidList',
                type: 'get',
                dataType: 'json',
                success: function (suc) {
                    var category1Html = '';
                    if(suc.code === 0){
                        category1Html += '<option value="">请选择父类目</option>';
                        $.each(suc.data, function(i, v) {
                            category1Html += '<option value="'+v.categoryId+'">'+v.categoryName+'</option>';
                        });
                    }else{
                        category1Html += '<option value="" selected="" disabled="">暂无数据</option>';
                    }
                    $("#category1").html(category1Html);
                    form.render("select");
                }
            });
        }
        //商品分类二级菜单联动
        form.on('select(category1)',function (data) {
            var v = data.value;
            if(v !== ''){
                $("#category2").empty();
                $.ajax({
                    url: '/category/getCategoryListByPid',
                    type: 'get',
                    dataType: 'json',
                    data: {'categoryId': v},
                    success: function (suc) {
                        var category2Html = '';
                        if(suc.code === 0){
                            category2Html += '<option value="">请选择子类目</option>';
                            $.each(suc.data, function(i, v) {
                                category2Html += '<option value="'+v.categoryId+'">'+v.categoryName+'</option>';
                            });
                        }else{
                            category2Html += '<option value="" selected="" disabled="">暂无数据</option>';
                        }
                        $("#category2").html(category2Html);
                        form.render("select");
                    }
                });
            }else{
                $("#category2").empty();
                $("#category2").html('<option value="">请选择子类目</option>');
                form.render("select");
            }
        })

    });


</script>
</html>