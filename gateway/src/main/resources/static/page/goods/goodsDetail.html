<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>修改商品信息</title>
</head>
<link rel="stylesheet" href="/js/layui/css/layui.css">
<script src="/js/layui/layui.all.js"></script>
<body>

<blockquote class="layui-elem-quote layui-text">
    Tips:为了用户观感,设计商品详情页内容时内容和图片大小宽建议为200PX,且内容尽量以图片的形式展示
</blockquote>

<form class="layui-form layui-form-pane" action="">

    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
        <legend>商品基本信息</legend>
    </fieldset>

    <div class="layui-form-item">
        <label class="layui-form-label">商品名称</label>
        <div class="layui-input-block">
            <input name="goodsName" id="goodsName" type="text" class="layui-input"
                   placeholder="请输入商品名称,不超过20个字" lay-verify="required" autocomplete="off">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">商品标语</label>
        <div class="layui-input-block">
            <input name="goodsBrief" id="goodsBrief" type="text" class="layui-input"
                   placeholder="请输入商品宣传标语,不超过30个字" lay-verify="required" autocomplete="off">
        </div>
    </div>

    <div class="layui-form-item" pane="">
        <label class="layui-form-label">是否上架</label>
        <div class="layui-input-block">
            <input type="checkbox" checked name="close" lay-skin="switch" lay-text="是|否">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">所属分类</label>
        <div class="layui-input-inlin">
            <div class="layui-input-inline">
                <select name="category1" id="category1" lay-filter="category1">
                </select>
            </div>
            <div class="layui-input-inline">
                <select name="category2" id="category2" lay-filter="category2">
                    <option value="">请选择子类目</option>
                </select>
            </div>
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">商品单位</label>
        <div class="layui-input-inline">
            <input name="goodsUnit" id="goodsUnit" type="text" placeholder="请输入商品单位,例如件、盒" class="layui-input"
                   lay-verify="required" autocomplete="off">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">商品单价</label>
        <div class="layui-input-inline">
            <input name="goodsPrice" id="goodsPrice" type="text" placeholder="￥" class="layui-input"
                   lay-verify="required|number" autocomplete="off">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">商品库存</label>
        <div class="layui-input-inline">
            <input name="goodsInventory" id="goodsInventory" type="text" placeholder="请输入商品库存" class="layui-input"
                   lay-verify="required|number" autocomplete="off" oninput="value=value.replace(/[^\d]/g,'')">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">商品详情页</label>
        <div class="layui-input-block">
            <textarea name="goodsDetail" id="goodsDetail"></textarea>
        </div>
    </div>

    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
        <legend>商品规格信息</legend>
    </fieldset>



    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
        <legend>商品参数设置</legend>
    </fieldset>

    <div class="layui-form-item">
        <label class="layui-form-label">商品参数</label>
        <div class="layui-input-inline">
            <button type="button" id="addAttribute" class="layui-btn layui-btn-primary"><i class="layui-icon">&#xe608;</i> 添加参数</button>
        </div>
    </div>

    <div style="padding: 20px; background-color: #F2F2F2;">
        <div class="layui-row layui-col-space15">
            <div class="layui-col-md12">
                <div class="layui-card">
                    <div class="layui-card-header">商品参数信息</div>
                    <div class="layui-card-body" >
                        <table class="layui-table" id="attributeTable">
<!--                            <tbody id="attributeTableContent">-->

<!--                            </tbody>-->
                            <tr>
                                <td>参数名</td>
                                <td>值</td>
                                <td>操作</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="layui-form-item">
        <div class="layui-input-block" style="text-align: center;">
            <button type="button" class="layui-btn" lay-submit lay-filter="doSubmit">
                <span class="layui-icon layui-icon-add-1"></span>
                提交
            </button>
            <button type="reset" class="layui-btn layui-btn-warm">
                <span class="layui-icon layui-icon-refresh-1"></span>
                重置
            </button>
        </div>
    </div>

</form>

<!-- 弹窗设置参数content -->
<div class="layui-row" id="attributeMessage" style="display:none;">
    <div class="layui-col-md12">
        <form class="layui-form layui-from-pane" action="" style="margin-top:20px">
            <div class="layui-form-item">
                <label class="layui-form-label">参数名</label>
                <div class="layui-input-inline">
                    <input type="text" name="attributeName" id="attributeName" lay-verify="required" autocomplete="off" placeholder="请输入参数名" class="layui-input">
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">参数值</label>
                <div class="layui-input-inline">
                    <input type="text" name="attributeValue" id="attributeValue" lay-verify="required" autocomplete="off" placeholder="请输入参数值" class="layui-input">
                </div>
            </div>

            <div class="layui-form-item" style="margin-top:40px">
                <div class="layui-input-block">
                    <button class="layui-btn  layui-btn-submit " lay-submit="" lay-filter="attributeSubmit">添加</button>
                    <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                </div>
            </div>
        </form>
    </div>
</div>
<button id="kkkkkk">aaaaaaaaaaaaaaaaaaaaaaaaaa</button>
</body>
<script>

    // tinymce.init({
    //     selector: '#goodsDetail',
    //     language: "zh_CN",
    //     images_upload_url:'上传的后台接口',
    //     width: '99%',
    //     height: 300,
    //     plugins: [
    //         "advlist autolink lists link image charmap preview",
    //         "searchreplace visualblocks fullscreen",
    //         "insertdatetime table contextmenu paste",
    //         "emoticons textcolor autoresize autosave"
    //     ],
    //     toolbar1: "undo redo | styleselect | fontselect | fontsizeselect | bold italic underline strikethrough | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent",
    //     toolbar2: "fullscreen preview | forecolor backcolor emoticons | table | link image| mybutton |restoredraft",
    //
    // });


    layui.extend({tinymce: '/js/tinymce/tinymce'}).use(['jquery', 'form', 'util', 'layer', 'tinymce'], function () {
        var $ = layui.jquery;
        var form = layui.form,
            layer = layui.layer,
            layedit = layui.layedit,
            laydate = layui.laydate;
        var util = layui.util;
        var tinymce = layui.tinymce;

        //表单渲染
        form.render();

        //初始化tinymce
        var goods_detail = tinymce.render({
            elem: "#goodsDetail",
            height: 300,
            width: '99%',
        }, (opt) => {
            //加载完成后回调
        });

        //初始化
        init();

        //提交表单
        form.on('submit(doSubmit)', function (data) {
            alert(tinymce.get("#goodsDetail").getContent());
            return false;
        });

        //商品参数设置相关
        var attributeIndex;
        //添加商品参数
        $("#addAttribute").click(function(){
            attributeIndex = layer.open({
                type:1,
                title:'添加商品参数信息',
                area : ['370px', '270px'],
                shadeClose:true,
                content: $("#attributeMessage")
            });
        });
        //提交商品参数信息
        form.on('submit(attributeSubmit)', function(data) {
            console.log(data);
            layer.close(attributeIndex);
            $("#attributeName").val("");
            $("#attributeValue").val("");
            var attributeTrHtml = "<tr>"
            attributeTrHtml += "<td>"+data.field.attributeName+"</td>"
            attributeTrHtml += "<td>"+data.field.attributeValue+"</td>"
            attributeTrHtml += "<td align:'center'><button class='layui-btn layui-btn-primary layui-btn-sm attributeDelete'>删除</button></td>"
            attributeTrHtml += "</tr>"
            $("#attributeTable").append(attributeTrHtml);
            return false;
        })
        //删除商品参数
        $("#attributeTable").on('click', '.attributeDelete', function () {
            $(this).closest('tr').remove();
        });
        //商品参数表格转json
        function table2Json(id) {
            var titles = $("#" + id).find("tr:first td");
            var json = "[" + $("#" + id).find("tr:not(:first)").map(function(i, e) {
                return "{" + $(e).children("td").map(function(j, el) {
                    return $(titles[j]).html() + ":" + $(el).html();
                }).get().join(",") + "}";
            }).get().join(",") + "]";
            var reg1 = new RegExp('参数名','g');
            json = json.replace(reg1,'"attributeName"');
            var reg2 = new RegExp('值','g');
            json = json.replace(reg2,'"attributeValue"');
            var reg3 = new RegExp(',操作:<button class="layui-btn layui-btn-primary layui-btn-sm attributeDelete">删除</button>','g');
            json = json.replace(reg3,'');
            return json;
        }

        function init() {
            //加载商品分类下拉框
            $.ajax({
                url: '/category/getCategoryPidList',
                type: 'get',
                dataType: 'json',
                success: function (suc) {
                    var category1Html = '';
                    if(suc.code === 0){
                        category1Html += '<option value="">请选择父类目</option>';
                        $.each(suc.data, function(i, v) {
                            category1Html += '<option value="'+v.categoryId+'">'+v.categoryName+'</option>';
                        });
                    }else{
                        category1Html += '<option value="" selected="" disabled="">暂无数据</option>';
                    }
                    $("#category1").html(category1Html);
                    form.render("select");
                }
            });
        }

        //商品分类二级菜单联动
        form.on('select(category1)',function (data) {
            var v = data.value;
            if(v !== ''){
                $("#category2").empty();
                $.ajax({
                    url: '/category/getCategoryListByPid',
                    type: 'get',
                    dataType: 'json',
                    data: {'categoryId': v},
                    success: function (suc) {
                        var category2Html = '';
                        if(suc.code === 0){
                            category2Html += '<option value="">请选择子类目</option>';
                            $.each(suc.data, function(i, v) {
                                category2Html += '<option value="'+v.categoryId+'">'+v.categoryName+'</option>';
                            });
                        }else{
                            category2Html += '<option value="" selected="" disabled="">暂无数据</option>';
                        }
                        $("#category2").html(category2Html);
                        form.render("select");
                    }
                });
            }else{
                $("#category2").empty();
                $("#category2").html('<option value="">请选择子类目</option>');
                form.render("select");
            }
        })


        $("#kkkkkk").click(function(){
            console.log(table2Json('attributeTable'));
        });
    });



</script>
</html>