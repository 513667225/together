<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>修改商品信息</title>
</head>
<link rel="stylesheet" href="/js/layui/css/layui.css">
<script src="/js/layui/layui.all.js"></script>
<body>

<form class="layui-form layui-form-pane" action="/goods/addGoods" id="goodsAddSubmit" method="post">

    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
        <legend>商品基本信息</legend>
    </fieldset>

    <div class="layui-form-item">
        <label class="layui-form-label">商家账号</label>
        <div class="layui-input-block">
            <input name="shopuser_name" id="shopuser_name" type="text" class="layui-input"
                   placeholder="请输入账号名称,不超过20个字" lay-verify="required" autocomplete="off">
        </div>
    </div>



    <div class="layui-form-item">
        <label class="layui-form-label">密码</label>
        <div class="layui-input-inlin">
            <div class="layui-input-inline">
                <input name="shopuser_password" id="shopuser_password" type="text" class="layui-input"
                       placeholder="密码长度不能小于6" lay-verify="required" autocomplete="off">
            </div>
            <label class="layui-form-label">确认密码</label>
            <div class="layui-input-inline">
                <input name="shopuser_password1" id="shopuser_password1" type="text" class="layui-input"
                       placeholder="密码长度不能小于6" lay-verify="required" autocomplete="off">
            </div>
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">店铺名称</label>
        <div class="layui-input-inline">
            <input name="shop_name" id="shop_name" type="text" placeholder="请输入商品单位,例如件、盒" class="layui-input"
                   lay-verify="required" autocomplete="off">
        </div>
    </div>
    <div class="layui-form-item" pane="">
        <label class="layui-form-label">是否线上</label>
        <div class="layui-input-block">
            <input type="checkbox" checked name="shop_type" lay-skin="switch" lay-text="是|否">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">店铺标语</label>
        <div class="layui-input-inline">
            <input name="shop_slogan" id="shop_slogan" type="text" placeholder="￥" class="layui-input"
                   lay-verify="required|number" autocomplete="off">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">店铺详细介绍</label>
        <div class="layui-input-block">
            <textarea name="shop_detail" id="shop_detail"></textarea>
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">经营范围</label>
        <div class="layui-input-inline">
            <input name=shop_category" id="shop_category" type="text" placeholder="请输入商品库存" class="layui-input">
        </div>
    </div>


    <div class="layui-form-item">
        <label class="layui-form-label">所属地区</label>
        <div class="layui-input-inlin">
            <div class="layui-input-inline">
                <select name="province" id="province" lay-filter="province">
                </select>
            </div>
            <div class="layui-input-inline">
                <select name="city" id="city" lay-filter="city">
                    <option value="">请选择市</option>
                </select>
            </div>
            <div class="layui-input-inline">
                <select name="area" id="area" lay-filter="">
                    <option value="">选择区域</option>
                </select>
            </div>
        </div>
    </div>




    <!-- 商品宣传图片上传 -->
    <blockquote class="layui-elem-quote layui-text">
        Tips:店铺图片列表,建议图片比列为16:9,店铺图片数量不可超过5张
    </blockquote>
    <div class="layui-form-item">
        <label class="layui-form-label">店铺图片</label>
        <div class="layui-upload-drag" id="goodsGalleryListUpload">
            <i class="layui-icon"></i>
            <p>点击上传或者拖拽图片上传</p>
        </div>
    </div>
    <blockquote class="layui-elem-quote layui-quote-nm" style="margin-top: 10px;">
        预览图：
        <div class="layui-upload-list" id="goodsGalleryPreview"></div>
    </blockquote>



    <div class="layui-form-item">
        <label class="layui-form-label">电话号码</label>
        <div class="layui-input-block">
            <input name="shop_tel" id="shop_tel" type="text" class="layui-input"
                   placeholder="请输入商品名称,不超过20个字" lay-verify="required" autocomplete="off">
        </div>
    </div>









    <div class="layui-form-item" style="display: none">
        <div class="layui-input-block">
            <input id="picUrl" name="picUrl" type="text" class="layui-input" autocomplete="off"> <input>
            <input id="specificationPic" name="specificationPic" type="text" class="layui-input" autocomplete="off"> <input>
            <input id="goodsGallery" name="goodsGallery" type="text" class="layui-input" autocomplete="off"> <input>
            <input id="attributeEntity" name="attributeEntity" type="text" class="layui-input" autocomplete="off"> <input>
        </div>
    </div>

    <!-- 提交按钮 -->
    <div class="layui-form-item" style="margin-top:40px">
        <div class="layui-input-block" style="text-align: center;">
            <button type="button" class="layui-btn" lay-filter="doSubmit" id="submitBtn">
                <span class="layui-icon layui-icon-add-1"></span>
                提交
            </button>
            <button type="reset" class="layui-btn layui-btn-warm">
                <span class="layui-icon layui-icon-refresh-1"></span>
                重置
            </button>
        </div>
    </div>

</form>


</body>
<script>
    var goodsGrallyList={};
    goodsGrallyList.title="xxx";
    goodsGrallyList.id="xxx";
    goodsGrallyList.start=0;
    var dataArray = new Array();
    var specificationPicFilePath;
    var picUrlFilePathFilePath;


    layui.extend({tinymce: '/js/tinymce/tinymce'}).use(['jquery', 'form', 'util', 'layer', 'tinymce','upload'], function () {
        var $ = layui.jquery;
        var form = layui.form,
            layer = layui.layer,
            layedit = layui.layedit,
            upload = layui.upload,
            laydate = layui.laydate;
        var util = layui.util;
        var tinymce = layui.tinymce;

        //表单渲染
        form.render();

        //初始化tinymce
        var goods_detail = tinymce.render({
            elem: "#goodsDetail",
            height: 300,
            width: '99%',
            images_upload_url: '/goods/uploadGoods',
        }, (opt) => {
            //加载完成后回调
        });

        //初始化
        init();

        //商品参数设置相关
        var attributeIndex;
        //添加商品参数
        $("#addAttribute").click(function(){
            attributeIndex = layer.open({
                type:1,
                title:'添加商品参数信息',
                area : ['370px', '270px'],
                shadeClose:true,
                content: $("#attributeMessage")
            });
        });
        //提交商品参数信息
        form.on('submit(attributeSubmit)', function(data) {
            layer.close(attributeIndex);
            $("#attributeName").val("");
            $("#attributeValue").val("");
            var attributeTrHtml = "<tr>"
            attributeTrHtml += "<td>"+data.field.attributeName+"</td>"
            attributeTrHtml += "<td>"+data.field.attributeValue+"</td>"
            attributeTrHtml += "<td align:'center'><button class='layui-btn layui-btn-primary layui-btn-sm attributeDelete'>删除</button></td>"
            attributeTrHtml += "</tr>"
            $("#attributeTable").append(attributeTrHtml);
            return false;
        })
        //删除商品参数
        $("#attributeTable").on('click', '.attributeDelete', function () {
            $(this).closest('tr').remove();
        });
        //商品参数表格转json
        function table2Json(id) {
            var titles = $("#" + id).find("tr:first td");
            var json = "[" + $("#" + id).find("tr:not(:first)").map(function(i, e) {
                return "{" + $(e).children("td").map(function(j, el) {
                    return $(titles[j]).html() + ':"' + $(el).html() +'"';
                }).get().join(",") + "}";
            }).get().join(",") + "]";
            var reg1 = new RegExp('参数名','g');
            json = json.replace(reg1,'"attributeName"');
            var reg2 = new RegExp('值','g');
            json = json.replace(reg2,'"attributeValue"');
            var reg3 = new RegExp(',操作:"<button class="layui-btn layui-btn-primary layui-btn-sm attributeDelete">删除</button>"','g');
            json = json.replace(reg3,'');
            return json;
        }


        //商品宣传图片上传 限制5张
        upload.render({
            elem: '#goodsGalleryListUpload',
            url: '/goods/uploadGoods',
            multiple: true,
            acceptMime: 'image/*',
            auto: false,
            size: 5120,
            bindAction: '#submitBtn',//submitBtn
            choose:function(obj){
                // obj.preview(function(index, file, result){
                //     $('#goodsGalleryPreview').append('<img id="goodsGrally'+index+'" style="width: 256px;height: 144px;margin-left: 10px" src="'+ result +'" alt="'+ file.name +'" class="layui-upload-img">')
                // });
                var files = obj.pushFile();
                var len = getJsonLength(files);
                obj.preview(function (index, file, result) {
                    if(parseInt(len)>5){
                        layer.msg("上传商品宣传图片数量不能超过五张", {icon: 5});
                        delete files[index];
                        len = getJsonLength(files);
                    }else{
                        $('#goodsGalleryPreview').append('<img id="goodsGrallyRemove_'+index+'" style="width: 256px;' +
                            'height: 144px;margin-left: 10px" src="'+ result +'" alt="'+ file.name +'" class="layui-upload-img">')
                        $('#goodsGrallyRemove_' + index).bind('dblclick', function () {
                            delete files[index];
                            len = getJsonLength(files);
                            $(this).remove();
                        });
                    }
                })
            },
            done: function(res){
                var jsonTemp={};
                jsonTemp.alt=res.fileName;
                jsonTemp.pid=1;
                jsonTemp.thumb="";
                jsonTemp.src=res.filePath;
                dataArray.push(jsonTemp);
            },
            allDone: function (res) {
                goodsGrallyList.data=dataArray;
                specificationPicUpload.upload();
            }
        });
        //图片json长度
        function getJsonLength(jsonData){
            var jsonLength = 0;
            for(var item in jsonData){
                jsonLength++;
            }
            return jsonLength;
        }

        //商品规格图片上传
        var specificationPicUpload=upload.render({
            elem: '#specificationPicUpload',
            url: '/goods/uploadGoods',
            acceptMime: 'image/*',
            auto: false,
            size: 5120,
            // bindAction: '#submitBtn',
            choose:function(obj){
                var files = obj.pushFile();
                var len = getJsonLength(files);
                obj.preview(function (index, file, result) {
                    if(parseInt(len)>1){
                        layer.msg("商品规格图为一张", {icon: 5});
                        delete files[index];
                        len = getJsonLength(files);
                    }else{
                        $('#specificationPicPreview').append('<img id="specificationPicRemove_'+index+'" style="width: 256px;' +
                            'height: 144px;margin-left: 10px" src="'+ result +'" alt="'+ file.name +'" class="layui-upload-img">')
                        $('#specificationPicRemove_' + index).bind('dblclick', function () {
                            delete files[index];
                            len = getJsonLength(files);
                            $(this).remove();
                        });
                    }
                })
            },
            done:function(res){
                specificationPicFilePath = res.filePath;
                picUrlUpload.upload();
            }
        });

        //商品首页展示图片上传
        var picUrlUpload=upload.render({
            elem: '#picUrlUpload',
            url: '/goods/uploadGoods',
            acceptMime: 'image/*',
            auto: false,
            size: 5120,
            // bindAction: '#submitBtn',
            choose:function(obj){
                var files = obj.pushFile();
                var len = getJsonLength(files);
                obj.preview(function (index, file, result) {
                    if(parseInt(len)>1){
                        layer.msg("商品首页展示图为一张", {icon: 5});
                        delete files[index];
                        len = getJsonLength(files);
                    }else{
                        $('#picUrlPreview').append('<img id="picUrlRemove_'+index+'" style="width: 256px;' +
                            'height: 144px;margin-left: 10px" src="'+ result +'" alt="'+ file.name +'" class="layui-upload-img">')
                        $('#picUrlRemove_' + index).bind('dblclick', function () {
                            delete files[index];
                            len = getJsonLength(files);
                            $(this).remove();
                        });
                    }
                })
            },
            done:function(res){
                picUrlFilePath = res.filePath;
                $("#picUrl").val(picUrlFilePath);
                $("#specificationPic").val(specificationPicFilePath);
                $("#goodsGallery").val(JSON.stringify(goodsGrallyList));
                $("#attributeEntity").val(table2Json("attributeTable"));
                $("#goodsAddSubmit").submit();
            }
        });

        //加载省份分类下拉框
        function init() {
            $.ajax({
                url: '/shop/queryRegion?pid=0',
                type: 'get',
                dataType: 'json',
                success: function (suc) {
                    var provineHtml = '';
                    if(suc.code == 0){
                        provineHtml += '<option value="">请选择父类目</option>';
                        $.each(suc.data, function(i, v) {
                            provineHtml += '<option value="'+v.id+'">'+v.name+'</option>';
                        });
                    }else{
                        provineHtml += '<option value="" selected="" disabled="">暂无数据</option>';
                    }
                    $("#province").html(provineHtml);
                    form.render("select");
                }
            });
        }

        //市级二级菜单联动
        form.on('select(province)',function (data) {

            var v = data.value;
            if(v !== ''){
                //$("#category2").empty();
                $.ajax({
                    url: '/shop/queryRegion?pid='+v,
                    type: 'get',
                    dataType: 'json',
                    success: function (suc) {
                        var cityHtml = '';
                        if(suc.code == 0){
                            cityHtml += '<option value="">请选择子类目</option>';
                            $.each(suc.data, function(i, v) {
                                cityHtml += '<option value="'+v.id+'">'+v.name+'</option>';
                            });
                        }else{
                            cityHtml += '<option value="" selected="" disabled="">暂无数据</option>';
                        }
                        $("#city").html(cityHtml);
                        form.render("select");
                    }
                });
            }else{
                $("#city").empty();
                $("#city").html('<option value="">请选择子类目</option>');
                form.render("select");
            }
        })



        //地区二级菜单联动
        form.on('select(city)',function (data) {

            var v = data.value;
            if(v !== ''){
                //$("#category2").empty();
                $.ajax({
                    url: '/shop/queryRegion?pid='+v,
                    type: 'get',
                    dataType: 'json',
                    success: function (suc) {
                        var areaHtml = '';
                        if(suc.code == 0){
                            areaHtml += '<option value="">请选择子类目</option>';
                            $.each(suc.data, function(i, v) {
                                areaHtml += '<option value="'+v.id+'">'+v.name+'</option>';
                            });
                        }else{
                            areaHtml += '<option value="" selected="" disabled="">暂无数据</option>';
                        }
                        $("#area").html(areaHtml);
                        form.render("select");
                    }
                });
            }else{
                $("#city").empty();
                $("#city").html('<option value="">请选择子类目</option>');
                form.render("select");
            }
        })

    });


</script>
</html>